<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>レシピ詳細 - Recipe2026</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<nav>
    <a href="index.html" style="font-size:1.5rem; text-decoration:none;"><img src="images/C'est trop bon logo.png" alt="" style="width: 80px;"></a>
    <div class="nav-links">
        <a href="renkin.html">食材錬金</a>
        <a href="roulette.html">食材ルーレット</a>
        <a href="ranking.html">ランキング</a>
        <a href="mypage.html">マイページ</a>
        <a href="auth.html">ログイン</a>
    </div>
</nav>
<div class="main">
    <img id="rImg" class="hero-img">
    <div class="p-20">
        <h1 id="rName">レシピ名</h1>
        <div style="margin-bottom:20px;">
            <button class="btn-action fav-btn" onclick="toggleFav()">❤️ お気に入り</button>
        </div>
        <div id="aiBox" style="display:none; background:#f5f3ff; padding:15px; border-radius:10px; margin-bottom:20px; border-left:4px solid #8b5cf6;"></div>

        <h3>材料</h3>
        <ul id="rIngs"></ul>

        <h3>作り方</h3>
        <ol id="rSteps"></ol>
        <a href="index.html">← 戻る</a>
    </div>
</div>
<script src="js/main.js"></script>
<script type="module">
  import { auth, db } from "./js/firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { doc, getDoc, setDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const recipeId = parseInt(new URLSearchParams(location.search).get("id"));

  // ✅ 閲覧数を Firestore に加算（ログイン不要・誰でもカウント）
  if(recipeId){
    const viewRef = doc(db, "recipeStats", String(recipeId));
    setDoc(viewRef, { views: increment(1) }, { merge: true }).catch(console.error);
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) return;
    const uid = user.uid;

    // ✅ 買い物リストを Firestore に保存
    window.addShop = async (text) => {
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      const data = snap.exists() ? snap.data() : { favs: [], shop: [], ingredients: [] };
      if (!data.shop.find(x => x.text === text)) {
        data.shop.push({ text, checked: false });
        await setDoc(ref, data, { merge: true });
      }
      alert("買い物リストに追加しました！");
    };

    // ✅ お気に入りを Firestore に保存
    window.toggleFav = async () => {
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      const data = snap.exists() ? snap.data() : { favs: [], shop: [], ingredients: [] };
      if (data.favs.includes(recipeId)) {
        data.favs = data.favs.filter(f => f !== recipeId);
      } else {
        data.favs.push(recipeId);
      }
      await setDoc(ref, data, { merge: true });
      // お気に入り数も recipeStats に反映
      const statsRef = doc(db, "recipeStats", String(recipeId));
      const isFaved = data.favs.includes(recipeId);
      await setDoc(statsRef, { favs: increment(isFaved ? 1 : -1) }, { merge: true });
      alert(isFaved ? "お気に入りに追加！" : "お気に入りを解除しました");
    };
  });
</script>
</body>
</html>
