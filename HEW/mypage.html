<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>MyPage - Recipe2026</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<nav>
    <a href="index.html" style="font-size:1.5rem; text-decoration:none;"><img src="images/C'est trop bon logo.png" alt="" style="width: 80px;"></a>
    <div class="nav-links">
        <a href="renkin.html">é£ŸæéŒ¬é‡‘</a>
        <a href="roulette.html">é£Ÿæãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</a>
        <a href="ranking.html">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a>
        <a href="mypage.html">ãƒã‚¤ãƒšãƒ¼ã‚¸</a>
        <a href="auth.html">ãƒ­ã‚°ã‚¤ãƒ³</a>
    </div>
</nav>
    <h1>ãƒã‚¤ãƒšãƒ¼ã‚¸</h1>
    <a href="index.html">â† ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</a>
    <div class="container-mypage" style="margin-top:20px;">
        <div class="box">
            <h2>â¤ï¸ ä¿å­˜ã—ãŸãƒ¬ã‚·ãƒ”</h2>
            <button onclick="resetFavs()" class="reset-btn">ğŸ—‘ ä¿å­˜ãƒ¬ã‚·ãƒ”ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
            <div id="favs"></div>
        </div>
        <div class="box">
            <h2>ğŸ›’ è²·ã„ç‰©ãƒªã‚¹ãƒˆ</h2>
            <button onclick="resetShop()" class="reset-btn">ğŸ—‘ ãƒªã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ</button>
            <div id="shops"></div>
        </div>
    </div>

<script src="js/main.js"></script>
<script type="module">
  import { auth, db } from "./js/firebase.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      location.href = "auth.html";
      return;
    }

    // ãƒŠãƒ“ã®ãƒ­ã‚°ã‚¤ãƒ³è¡¨ç¤ºã‚’ãƒ¡ã‚¢ãƒ‰ã«å¤‰ãˆã‚‹
    const nav = document.querySelector(".nav-links a[href='auth.html']");
    if(nav) nav.textContent = user.email;

    const uid = user.uid; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®å›ºæœ‰ID

    // Firestoreã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
    const docSnap = await getDoc(doc(db, "users", uid));
    const data = docSnap.exists() ? docSnap.data() : { favs: [], shop: [], ingredients: [] };

    // ãŠæ°—ã«å…¥ã‚Šè¡¨ç¤º
    const favsEl = document.getElementById("favs");
    if(favsEl){
      favsEl.innerHTML = recipes
        .filter(r => data.favs.includes(r.id))
        .map(r => `<div class="list-item"><a href="detail.html?id=${r.id}">${r.name}</a></div>`)
        .join("") || "ãªã—";
    }

    // è²·ã„ç‰©ãƒªã‚¹ãƒˆè¡¨ç¤º
    const shopsEl = document.getElementById("shops");
    if(shopsEl){
      shopsEl.innerHTML = data.shop
        .map((x, i) => `<div class="list-item ${x.checked ? "checked" : ""}"
          onclick="toggleShopFirestore('${uid}', ${i})">${x.text}</div>`)
        .join("") || "ç©º";
    }

    // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ä¸Šæ›¸ã
    window.resetFavs = async () => {
      if(!confirm("ä¿å­˜ã—ãŸãƒ¬ã‚·ãƒ”ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      await setDoc(doc(db, "users", uid), { ...data, favs: [] }, { merge: true });
      location.reload();
    };

    window.resetShop = async () => {
      if(!confirm("è²·ã„ç‰©ãƒªã‚¹ãƒˆã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      await setDoc(doc(db, "users", uid), { ...data, shop: [] }, { merge: true });
      location.reload();
    };

    window.toggleShopFirestore = async (uid, index) => {
      data.shop[index].checked = !data.shop[index].checked;
      await setDoc(doc(db, "users", uid), { ...data }, { merge: true });
      location.reload();
    };
  });
</script>
</body>
</html>



